<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è©•åˆ†çµæœï½œå€‹äººå ±å‘Š</title>
  <style>
    body { font-family: "Noto Sans TC", sans-serif; padding: 2rem; line-height: 1.6; }
    #downloadPdfBtn { margin-top: 1rem; padding: .5rem 1rem; }
  </style>
</head>
<body>
  <h2>ğŸ“Š è©•åˆ†çµæœ</h2>
  <button id="downloadPdfBtn">ä¸‹è¼‰è©•åˆ†çµæœâ€¯PDF</button>

  <div id="basicInfo"></div>
  <div id="fitSummary" style="margin-top:1rem;"></div>
  <canvas id="radarChart" width="500" height="500" style="max-width:100%;margin-top:1rem;"></canvas>

  <!-- CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.9.2/dist/html2pdf.bundle.min.js"></script>

<script>
/* ===== è®€å– localStorage ===== */
const idx = new URLSearchParams(location.search).get("feedback");
const feedbacks = JSON.parse(localStorage.getItem("feedbacks") || "[]");
const fb = feedbacks[idx];

/* ===== åŒ¯å‡º PDF ===== */
document.getElementById("downloadPdfBtn").addEventListener("click", () => {
  const fname = fb ? `è©•åˆ†çµæœ_${fb.name}.pdf` : "è©•åˆ†çµæœ.pdf";
  html2pdf().from(document.body).set({ filename: fname, html2canvas: { scale: 2 } }).save();
});

/* ===== è³‡è¨Šé¡¯ç¤º ===== */
if (!fb) {
  document.body.insertAdjacentHTML("beforeend", "<p>âŒ æ‰¾ä¸åˆ°è©•åˆ†è³‡æ–™</p>");
} else {
  /* åŸºæœ¬è³‡æ–™ */
  document.getElementById("basicInfo").innerHTML = `
    <p>ğŸ‘¤ è¢«è©•äººï¼š${fb.name}</p>
    <p>ğŸ“Œ è·ä½åç¨±ï¼š${fb.role}</p>
    <p>ğŸ•’ æäº¤æ™‚é–“ï¼š${new Date(+fb.submittedAt).toLocaleString("zh-TW")}</p>
  `;

  /* é©é…åº¦èªªæ˜ï¼ˆè‹¥ç¼ºå€¼å‰‡å³æ™‚è¨ˆç®—ï¼‰ */
  let explain = fb.scoreExplanation;
  const total = +fb.scoreTotal;
  if (!explain) {
    explain = total >= 4.5 ? "å®Œå…¨ç¬¦åˆè·ä½æ¢ä»¶ï¼Œå…·å‚™å…¨é¢å‹ä»»æ½›åŠ›ã€‚"
      : total >= 3.5 ? "å¤§éƒ¨åˆ†ç¬¦åˆè·ä½è¦æ±‚ï¼Œå…·å‚™å‹ä»»åŸºç¤ä¸”æ½›åŠ›è‰¯å¥½ã€‚"
      : total >= 2.5 ? "éƒ¨åˆ†ç¬¦åˆç¡¬æŒ‡æ¨™ï¼Œéœ€æ™‚é–“é©æ‡‰èˆ‡å­¸ç¿’ã€‚"
      : total >= 1.5 ? "èˆ‡éœ€æ±‚æœ‰è½å·®ï¼Œéœ€å¤§é‡åŸ¹è¨“èˆ‡æŒ‡å°æ‰èƒ½å‹‰å¼·å‹ä»»ã€‚"
      : "èƒŒæ™¯èˆ‡èƒ½åŠ›çš†ä¸ç¬¦ï¼Œé›£ä»¥å‹ä»»è©²è·ä½ã€‚";
  }
  document.getElementById("fitSummary").innerHTML = `
    <h3>ğŸ” é©é…åº¦åˆ†æ</h3>
    <p><strong>ç¸½åˆ†ï¼š</strong>${total.toFixed(2)} / 5</p>
    <p><strong>åŒ¹é…ç¨‹åº¦ï¼š</strong>${fb.scoreLevel}</p>
    <p>${explain}</p>
  `;

  /* é›·é”åœ– */
  const roles = JSON.parse(localStorage.getItem("roles") || "[]");
  const roleObj = roles.find(r => r.role === fb.role) || {};
  const labels = [];

  (roleObj.hard ? Object.values(roleObj.hard) : []).forEach(i => labels.push(i.title || "ç¡¬æŒ‡æ¨™"));
  (roleObj.soft || []).forEach(i => labels.push(i.title));
  (roleObj.trait || []).forEach(i => labels.push(i.title));

  new Chart(document.getElementById("radarChart"), {
    type: "radar",
    data: {
      labels,
      datasets: [{
        label: "å¾—åˆ†",
        data: fb.scores,
        fill: true,
        borderColor: "rgba(54,162,235,1)",
        backgroundColor: "rgba(54,162,235,0.2)",
        pointBackgroundColor: "rgba(54,162,235,1)"
      }]
    },
    options: { scales: { r: { suggestedMin: 0, suggestedMax: 5, ticks: { stepSize: 1 } } } }
  });
}
</script>
</body>
</html>
