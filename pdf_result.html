<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>評分結果｜個人報告</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Noto Sans TC", sans-serif; padding: 2rem; line-height: 1.6; }
    h2 { margin-bottom: 1rem; }
    .summary { margin-top: 2rem; padding: 1rem; background: #f9f9f9; border: 1px solid #ccc; }
    canvas { max-width: 500px; margin-top: 1rem; }
  </style>
</head>
<body>
  <h2>📊 評分結果報告</h2>
  <div id="basicInfo"></div>
  <div>
    <canvas id="radarChart"></canvas>
  </div>
  <div id="fitSummary" class="summary"></div>

<button onclick="window.print()" style="margin-top: 2rem; padding: 0.5rem 1rem;">📥 匯出報告</button>

<script>
  const index = new URLSearchParams(window.location.search).get("feedback");
  const feedbacks = JSON.parse(localStorage.getItem("feedbacks") || "[]");
  const fb = feedbacks[index];

  if (!fb) {
    document.getElementById("basicInfo").innerHTML = "<p>找不到評分資料。</p>";
  } else {
    document.getElementById("basicInfo").innerHTML = `
      <p>👤 被評人：${fb.name}</p>
      <p>📌 職位名稱：${fb.role}</p>
      <p>🕒 提交時間：${new Date(fb.submittedAt).toLocaleString("zh-TW")}</p>
    `;

    const total = parseFloat(fb.scoreTotal);
    let level = fb.scoreLevel;
    let explanation = fb.scoreExplanation;

    document.getElementById("fitSummary").innerHTML = `
      <h3>🔎 適配度分析</h3>
      <p><strong>總分：</strong>${total.toFixed(2)} 分</p>
      <p><strong>匹配程度：</strong>${level}</p>
      <p>${explanation}</p>
    `;

    // 設定雷達圖資料
    const totalLen = fb.scores.length;
    const countHard = 3;
    const role = JSON.parse(localStorage.getItem("roles"))?.find(r => r.role === fb.role);
    const countSoft = role?.soft?.length || 0;
    const countTrait = role?.trait?.length || 0;

    const avg = (arr) => arr.reduce((a, b) => a + b, 0) / arr.length;
    const hardAvg = avg(fb.scores.slice(0, 3));
    const softAvg = avg(fb.scores.slice(3, 3 + countSoft));
    const traitAvg = avg(fb.scores.slice(3 + countSoft, 3 + countSoft + countTrait));

    new Chart(document.getElementById("radarChart"), {
      type: "radar",
      data: {
        labels: ["硬指標", "軟實力", "人格特質"],
        datasets: [{
          label: "平均分數",
          data: [hardAvg, softAvg, traitAvg],
          fill: true,
          borderColor: "rgba(54, 162, 235, 1)",
          backgroundColor: "rgba(54, 162, 235, 0.2)",
          pointBackgroundColor: "rgba(54, 162, 235, 1)",
          pointBorderColor: "#fff",
          pointHoverBackgroundColor: "#fff",
          pointHoverBorderColor: "rgba(54, 162, 235, 1)",
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
        },
        scales: {
          r: {
            suggestedMin: 0,
            suggestedMax: 5,
            ticks: {
              stepSize: 1,
              backdropColor: "transparent"
            },
            grid: {
              color: "#ccc"
            },
            pointLabels: {
              font: { size: 14 }
            }
          }
        }
      }
    });
  }
</script>
</body>
</html>
