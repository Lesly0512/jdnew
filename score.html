<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>關鍵崗位畫像評分</title>
  <style>
    body { font-family: "Noto Sans TC", sans-serif; padding: 2rem; line-height: 1.6; }
    h2 { margin-bottom: 0.5rem; }
    .section-block { border: 1px solid #ccc; padding: 1rem; margin-top: 1rem; background: #fafafa; }
    label { font-weight: bold; display: block; margin-top: 1rem; }
    select, input[type="text"] { width: 100%; padding: 0.5rem; }
    .rating-group { margin-top: 0.5rem; }
    .rating-group label { margin-right: 1rem; }
    .submit-btn { margin-top: 2rem; padding: 0.5rem 1rem; }
  </style>
</head>
<body>

  <h2>📝 關鍵崗位畫像評分</h2>
  <div id="jobInfo"></div>

  <label for="personName">被評人姓名</label>
  <input type="text" id="personName" required />

  <form id="scoreForm">
<div id="ratingArea"></div>
    <button class="submit-btn" type="submit">提交評分</button>
  </form>
<script>
const roleIndex = new URLSearchParams(window.location.search).get("index");
const roles = JSON.parse(localStorage.getItem("roles") || "[]");
const role = roles[roleIndex];

function renderIndicators(role) {
  const container = document.getElementById("ratingArea");
  container.innerHTML = "";
  const sections = [
    { title: "學歷", item: role.hard.edu },
    { title: "經歷", item: role.hard.exp },
    { title: "專業技能", item: role.hard.skill },
    ...role.soft.map(s => ({ title: s.title, item: s })),
    ...role.trait.map(t => ({ title: t.title, item: t }))
  ];
  sections.forEach((sec, idx) => {
    const block = document.createElement("div");
    block.className = "section-block";
    block.innerHTML = \`
      <h4>\${sec.title}</h4>
      <p>\${sec.item.desc}</p>
      <div class="rating-group">
      \${sec.item.scores.map((desc, i) => \`
        <label>
          <input type="radio" name="score\${idx}" value="\${5 - i}" required /> \${5 - i}
          <span style="margin-left:4px;">\${desc}</span>
        </label><br/>\`).join("")}
      </div>
    \`;
    container.appendChild(block);
  });
}

if (!role) {
  document.getElementById("jobInfo").innerHTML = "<p>查無職位資料。</p>";
  document.getElementById("scoreForm").style.display = "none";
} else {
  document.getElementById("jobInfo").innerHTML = \`
    <h3>\${role.role}</h3>
    <p>\${role.description}</p>
  \`;
  renderIndicators(role);
}

// handle form submit
document.getElementById("scoreForm").addEventListener("submit", function(e){
  e.preventDefault();
  const name = document.getElementById("personName").value.trim();
  if (!name) { alert("請輸入被評人姓名"); return; }

  const form = new FormData(this);
  const scores = [];
  for (let val of form.values()) { scores.push(parseInt(val, 10)); }

  const weights = { hard: 0.4, soft: 0.3, trait: 0.3 };
  const hardAvg = (scores.slice(0,3).reduce((a,b)=>a+b,0))/3;
  const softCount = role.soft.length;
  const softAvg = softCount ? (scores.slice(3,3+softCount).reduce((a,b)=>a+b,0))/softCount : 0;
  const traitStart = 3+softCount;
  const traitCount = role.trait.length;
  const traitAvg = traitCount ? (scores.slice(traitStart, traitStart+traitCount).reduce((a,b)=>a+b,0))/traitCount : 0;

  const total = hardAvg*weights.hard + softAvg*weights.soft + traitAvg*weights.trait;

  let level = "";
  let explanation = "";
  if (total >= 4.5) {
      level = "高度匹配";
      explanation = "完全符合職位條件，具備全面勝任潛力。";
  } else if (total >= 3.5) {
      level = "良好匹配";
      explanation = "大部分符合職位要求，具備勝任基礎且潛力良好。";
  } else if (total >= 2.5) {
      level = "部分匹配";
      explanation = "部分符合硬指標，某些軟實力需培養，能勝任但需時間適應與學習。";
  } else if (total >= 1.5) {
      level = "低度匹配";
      explanation = "與需求有落差，需大量培訓與指導才能勉強勝任。";
  } else {
      level = "完全不匹配";
      explanation = "背景與能力皆不符，難以勝任該職位，培養成本過高。";
  }

  const feedbacks = JSON.parse(localStorage.getItem("feedbacks") || "[]");
  feedbacks.push({
      name,
      role: role.role,
      scores,
      scoreTotal: total.toFixed(2),
      scoreLevel: level,
      scoreExplanation: explanation,
      submittedAt: Date.now()
  });
  localStorage.setItem("feedbacks", JSON.stringify(feedbacks));
  alert("✅ 評分完成，資料已儲存！");
  location.href = "pdf_result.html?feedback=" + (feedbacks.length - 1);
});
</script>

</body>
</html>