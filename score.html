<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é—œéµå´—ä½ç•«åƒè©•åˆ†</title>
  <style>
    body { font-family: "Noto Sans TC", sans-serif; padding: 2rem; line-height: 1.6; }
    h2 { margin-bottom: .5rem; }
    .section { border: 1px solid #ccc; padding: 1rem; margin-top: 1rem; background:#fafafa; }
    .rating label { margin-right:1rem; display:inline-block; }
    .submit-btn { margin-top:2rem; padding:.5rem 1rem; }
  </style>
</head>
<body>
  <h2>ğŸ“ é—œéµå´—ä½ç•«åƒè©•åˆ†</h2>
  <div id="jobInfo"></div>

  <label for="personName">è¢«è©•äººå§“å</label>
  <input id="personName" type="text" required style="width:100%;padding:.5rem;" />

  <form id="scoreForm">
    <div id="ratingArea"></div>
    <button type="submit" class="submit-btn">æäº¤è©•åˆ†</button>
  </form>

<script>
/* ===== æŠ“å–è·ä½è³‡æ–™ ===== */
const idx = new URLSearchParams(location.search).get("index");
const roles = JSON.parse(localStorage.getItem("roles") || "[]");
const role = roles[idx];

if (!role) {
  document.body.insertAdjacentHTML("beforeend","<p>âŒ æ‰¾ä¸åˆ°è·ä½è³‡æ–™</p>");
  document.getElementById("scoreForm").style.display="none";
} else {
  document.getElementById("jobInfo").innerHTML = `<h3>${role.role}</h3><p>${role.description||""}</p>`;
  renderIndicators(role);
}

/* ===== å‹•æ…‹ç”¢ç”ŸæŒ‡æ¨™ ===== */
function renderIndicators(role){
  const wrap=document.getElementById("ratingArea");
  wrap.innerHTML="";

  const sections=[];
  if(role.hard) Object.values(role.hard).forEach(i=>sections.push(i));
  (role.soft || []).forEach(i=>sections.push(i));
  (role.trait || []).forEach(i=>sections.push(i));

  sections.forEach((sec, i)=>{
    const div=document.createElement("div");
    div.className="section";
    div.innerHTML=`
      <h4>${sec.title || "æŒ‡æ¨™"}</h4>
      <p>${sec.desc || ""}</p>
      <div class="rating">
        ${sec.scores.map((d, k)=>`
          <label>
            <input type="radio" name="score${i}" value="${5-k}" required> ${5-k}ï¼${d}
          </label>
        `).join("<br>")}
      </div>`;
    wrap.appendChild(div);
  });
}

/* ===== è¡¨å–®æäº¤ ===== */
document.getElementById("scoreForm").addEventListener("submit",e=>{
  e.preventDefault();
  const name=document.getElementById("personName").value.trim();
  if(!name){alert("è«‹è¼¸å…¥è¢«è©•äººå§“å");return;}

  const radios=[...document.querySelectorAll('input[type="radio"]:checked')];
  const scores=radios.map(r=>+r.value);

  /* === åˆ†æ•¸åŠ æ¬Š === */
  const hardCnt=role.hard?Object.keys(role.hard).length:0,
        softCnt=(role.soft||[]).length,
        traitCnt=(role.trait||[]).length;

  const hardAvg = hardCnt ? avg(scores.slice(0,hardCnt)) : 0;
  const softAvg = softCnt ? avg(scores.slice(hardCnt,hardCnt+softCnt)) : 0;
  const traitAvg= traitCnt ? avg(scores.slice(hardCnt+softCnt)) : 0;

  const total=hardAvg*0.4+softAvg*0.3+traitAvg*0.3;

  let level, explain;
  if(total>=4.5){level="é«˜åº¦åŒ¹é…";explain="å®Œå…¨ç¬¦åˆè·ä½æ¢ä»¶ï¼Œå…·å‚™å…¨é¢å‹ä»»æ½›åŠ›ã€‚";}
  else if(total>=3.5){level="è‰¯å¥½åŒ¹é…";explain="å¤§éƒ¨åˆ†ç¬¦åˆè·ä½è¦æ±‚ï¼Œå…·å‚™å‹ä»»åŸºç¤ä¸”æ½›åŠ›è‰¯å¥½ã€‚";}
  else if(total>=2.5){level="éƒ¨åˆ†åŒ¹é…";explain="éƒ¨åˆ†ç¬¦åˆç¡¬æŒ‡æ¨™ï¼Œéœ€æ™‚é–“é©æ‡‰èˆ‡å­¸ç¿’ã€‚";}
  else if(total>=1.5){level="ä½åº¦åŒ¹é…";explain="èˆ‡éœ€æ±‚æœ‰è½å·®ï¼Œéœ€å¤§é‡åŸ¹è¨“èˆ‡æŒ‡å°æ‰èƒ½å‹‰å¼·å‹ä»»ã€‚";}
  else {level="å®Œå…¨ä¸åŒ¹é…";explain="èƒŒæ™¯èˆ‡èƒ½åŠ›çš†ä¸ç¬¦ï¼Œé›£ä»¥å‹ä»»è©²è·ä½ã€‚";}

  /* === å„²å­˜ feedback === */
  const fb=JSON.parse(localStorage.getItem("feedbacks")||"[]");
  fb.push({name,role:role.role,scores,scoreTotal:total.toFixed(2),scoreLevel:level,scoreExplanation:explain,submittedAt:Date.now()});
  localStorage.setItem("feedbacks",JSON.stringify(fb));

  alert("âœ… è©•åˆ†å®Œæˆï¼Œè³‡æ–™å·²å„²å­˜ï¼");
  location.href=`pdf_result.html?feedback=${fb.length-1}`;
});

function avg(arr){return arr.reduce((a,b)=>a+b,0)/arr.length;}
</script>
</body>
</html>
