<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>關鍵崗位畫像評分</title>
  <style>
    body { font-family: "Noto Sans TC", sans-serif; padding: 2rem; line-height: 1.6; }
    h2 { margin-bottom: .5rem; }
    .section { border: 1px solid #ccc; padding: 1rem; margin-top: 1rem; background:#fafafa; }
    .rating label { margin-right:1rem; display:inline-block; }
    .submit-btn { margin-top:2rem; padding:.5rem 1rem; }
  </style>
</head>
<body>
  <h2>📝 關鍵崗位畫像評分</h2>
  <div id="jobInfo"></div>

  <label for="personName">被評人姓名</label>
  <input id="personName" type="text" required style="width:100%;padding:.5rem;" />

  <form id="scoreForm">
    <div id="ratingArea"></div>
    <button type="submit" class="submit-btn">提交評分</button>
  </form>

<script>
/* ===== 抓取職位資料 ===== */
const idx = new URLSearchParams(location.search).get("index");
const roles = JSON.parse(localStorage.getItem("roles") || "[]");
const role = roles[idx];

if (!role) {
  document.body.insertAdjacentHTML("beforeend","<p>❌ 找不到職位資料</p>");
  document.getElementById("scoreForm").style.display="none";
} else {
  document.getElementById("jobInfo").innerHTML = `<h3>${role.role}</h3><p>${role.description||""}</p>`;
  renderIndicators(role);
}

/* ===== 動態產生指標 ===== */
function renderIndicators(role){
  const wrap=document.getElementById("ratingArea");
  wrap.innerHTML="";

  const sections=[];
  if(role.hard) Object.values(role.hard).forEach(i=>sections.push(i));
  (role.soft || []).forEach(i=>sections.push(i));
  (role.trait || []).forEach(i=>sections.push(i));

  sections.forEach((sec, i)=>{
    const div=document.createElement("div");
    div.className="section";
    div.innerHTML=`
      <h4>${sec.title || "指標"}</h4>
      <p>${sec.desc || ""}</p>
      <div class="rating">
        ${sec.scores.map((d, k)=>`
          <label>
            <input type="radio" name="score${i}" value="${5-k}" required> ${5-k}－${d}
          </label>
        `).join("<br>")}
      </div>`;
    wrap.appendChild(div);
  });
}

/* ===== 表單提交 ===== */
document.getElementById("scoreForm").addEventListener("submit",e=>{
  e.preventDefault();
  const name=document.getElementById("personName").value.trim();
  if(!name){alert("請輸入被評人姓名");return;}

  const radios=[...document.querySelectorAll('input[type="radio"]:checked')];
  const scores=radios.map(r=>+r.value);

  /* === 分數加權 === */
  const hardCnt=role.hard?Object.keys(role.hard).length:0,
        softCnt=(role.soft||[]).length,
        traitCnt=(role.trait||[]).length;

  const hardAvg = hardCnt ? avg(scores.slice(0,hardCnt)) : 0;
  const softAvg = softCnt ? avg(scores.slice(hardCnt,hardCnt+softCnt)) : 0;
  const traitAvg= traitCnt ? avg(scores.slice(hardCnt+softCnt)) : 0;

  const total=hardAvg*0.4+softAvg*0.3+traitAvg*0.3;

  let level, explain;
  if(total>=4.5){level="高度匹配";explain="完全符合職位條件，具備全面勝任潛力。";}
  else if(total>=3.5){level="良好匹配";explain="大部分符合職位要求，具備勝任基礎且潛力良好。";}
  else if(total>=2.5){level="部分匹配";explain="部分符合硬指標，需時間適應與學習。";}
  else if(total>=1.5){level="低度匹配";explain="與需求有落差，需大量培訓與指導才能勉強勝任。";}
  else {level="完全不匹配";explain="背景與能力皆不符，難以勝任該職位。";}

  /* === 儲存 feedback === */
  const fb=JSON.parse(localStorage.getItem("feedbacks")||"[]");
  fb.push({name,role:role.role,scores,scoreTotal:total.toFixed(2),scoreLevel:level,scoreExplanation:explain,submittedAt:Date.now()});
  localStorage.setItem("feedbacks",JSON.stringify(fb));

  alert("✅ 評分完成，資料已儲存！");
  location.href=`pdf_result.html?feedback=${fb.length-1}`;
});

function avg(arr){return arr.reduce((a,b)=>a+b,0)/arr.length;}
</script>
</body>
</html>
